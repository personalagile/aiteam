<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AITEAM Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-3">AITEAM Chat</h1>
  <div class="card">
    <div class="card-body">
      <div id="log" class="mb-3" style="height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px;"></div>
      <div class="input-group">
        <input id="msg" class="form-control" placeholder="Deine Nachricht an den Product Owner..."/>
        <button id="send" class="btn btn-primary">Senden</button>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  const log = document.getElementById('log');
  const msg = document.getElementById('msg');
  const btn = document.getElementById('send');
  const scheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const wsUrl = `${scheme}://${window.location.host}/ws/chat/`;
  const ws = new WebSocket(wsUrl);

  function addLine(text, cls=''){
    const p = document.createElement('div');
    if(cls) p.className = cls;
    p.textContent = text;
    log.appendChild(p);
    log.scrollTop = log.scrollHeight;
  }

  ws.onopen = () => addLine('Verbunden.', 'text-success');
  ws.onmessage = (ev) => {
    try {
      const data = JSON.parse(ev.data);
      // Backward compatibility: old final message
      if (data.type === 'po_plan' && Array.isArray(data.tasks)) {
        addLine('po_plan:', '');
        data.tasks.forEach((t) => addLine(`- ${t}`, ''));
        return;
      }

      switch (data.type) {
        case 'po_plan_start':
          addLine(`plan: ${data.message || 'started'}`, 'text-secondary');
          break;
        case 'po_plan_step':
          addLine(`step ${data.index}: ${data.task}`, '');
          break;
        case 'po_plan_final':
          addLine(`${data.message || 'plan ready'}:`, 'fw-bold');
          (data.tasks || []).forEach((t) => addLine(`- ${t}`, ''));
          break;
        case 'ac_feedback':
          addLine(`ac: ${data.message}`, 'fst-italic');
          break;
        case 'expert_update':
          if (data.expert) {
            addLine(`expert ${data.expert}: ${data.message}`, '');
          } else if (Array.isArray(data.experts)) {
            addLine(`experts: ${(data.experts || []).join(', ')}`, '');
          } else {
            addLine(`expert: ${data.message || ''}`, '');
          }
          break;
        default:
          if (typeof data.message !== 'undefined') {
            addLine(`${data.type || 'message'}: ${data.message}`, '');
          } else {
            addLine(ev.data, '');
          }
      }
    } catch {
      addLine(ev.data, '');
    }
  };
  ws.onerror = () => addLine('WebSocket Fehler.', 'text-danger');
  ws.onclose = () => addLine('Verbindung geschlossen.', 'text-danger');

  btn.onclick = () => {
    const text = msg.value.trim();
    if(!text) return;
    ws.send(JSON.stringify({message: text}));
    addLine(`you: ${text}`, 'fw-bold');
    msg.value = '';
    msg.focus();
  };
})();
</script>
</body>
</html>
